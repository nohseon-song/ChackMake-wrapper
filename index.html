<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CheckMake PRO-Ultra</title>

  <!-- GitHub Pages 프로젝트 경로 BASE -->
  <script>window.__BASE__ = "/ChackMake-wrapper/";</script>

  <!-- Manifest & Icons -->
  <link rel="manifest" id="mf">
  <link rel="apple-touch-icon" id="ico180">
  <link rel="icon" sizes="192x192" id="ico192">
  <link rel="icon" sizes="512x512" id="ico512">
  <meta name="theme-color" content="#111827">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
         display:grid;place-items:center;height:100vh;margin:0}
    .wrap{display:flex;flex-direction:column;gap:16px;align-items:center}
    .btn{padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .primary{background:#2563eb;color:#fff}
    .ghost{background:#f4f4f5}
    img.logo{width:88px;height:88px;border-radius:22px}
    .err{color:#b91c1c;font-size:.9rem;text-align:center;display:none;max-width:600px}
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" id="logo" alt="logo"/>
    <h1>CheckMake PRO-Ultra</h1>
    <button id="install" class="btn primary" style="display:none">홈 화면에 추가 / 앱 설치</button>
    <button id="open" class="btn ghost">앱 열기</button>
    <div id="err" class="err"></div>
  </div>

  <script>
    const BASE = window.__BASE__;
    const APP_URL = "https://chackmake-query-tool.lovable.app/auth";

    // 절대 경로 주입
    document.getElementById('mf').href      = `${BASE}manifest.json`;
    document.getElementById('ico180').href  = `${BASE}icons/icon-192.png`;
    document.getElementById('ico192').href  = `${BASE}icons/icon-192.png`;
    document.getElementById('ico512').href  = `${BASE}icons/icon-512.png`;
    document.getElementById('logo').src     = `${BASE}icons/icon-512.png`;

    // SW 등록
    let swReady = Promise.resolve();
    if ('serviceWorker' in navigator) {
      swReady = navigator.serviceWorker.register(`${BASE}sw.js`);
    }

    // beforeinstallprompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install').style.display = 'inline-block';
      console.log('[PWA] beforeinstallprompt fired');
    });

    document.getElementById('install').addEventListener('click', async () => {
      if (!deferredPrompt) { alert("설치가 지원되지 않거나 이미 설치됨."); return; }
      await deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      console.log('[PWA] userChoice:', choice);
      deferredPrompt = null;
    });

    document.getElementById('open').addEventListener('click', async () => {
      await swReady;
      location.href = APP_URL;
    });

    // 이미 PWA 모드라면 바로 이동
    if (window.matchMedia('(display-mode: standalone)').matches) {
      location.replace(APP_URL);
    }

    // 경로 오류 진단
    async function healthCheck(){
      const err = document.getElementById('err');
      const items = [
        ['manifest', `${BASE}manifest.json`],
        ['icon512', `${BASE}icons/icon-512.png`],
        ['sw',       `${BASE}sw.js`],
      ];
      const fails = [];
      for (const [name, url] of items) {
        try {
          const r = await fetch(url, {method:'HEAD', cache:'no-store'});
          if (!r.ok) fails.push(`${name}: ${r.status}`);
        } catch(e){ fails.push(`${name}: fetch error`); }
      }
      if (fails.length){
        err.style.display='block';
        err.textContent = "리소스 경로 오류: " + fails.join(' | ') +
          `\n(BASE가 '${BASE}'로 설정되어 있습니다. 리포 이름이 다르면 수정하세요.)`;
      }
    }
    healthCheck();
  </script>
</body>
</html>
